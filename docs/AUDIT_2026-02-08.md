# Data Infrastructure Audit - 8 February 2026

## Executive Summary

Full audit of the Better Signal data infrastructure covering: sync freshness, PII hashing compliance, data quality (duplicates, continuity, nulls), and cross-platform analysis readiness.

**Overall Status: NEEDS ATTENTION**
- PII Hashing: PASS (100% coverage, zero plaintext)
- Data Quality: PASS (no nulls, hashes consistent)
- Sync Freshness: FAIL (Facebook 6 days stale, Shopify/TikTok 3 days)
- Duplicates: WARNING (Facebook 20.9% dupes from append mode - dedup view created)

---

## 1. Sync Freshness Status

| Source | Latest Data | Lag | Status | Estimated Impact |
|--------|------------|-----|--------|-----------------|
| Shopify Live Orders | Feb 5 | 3 days | WARNING | ~$270K revenue untracked |
| Shopify Live Customers | Feb 5 | 3 days | WARNING | Customer data stale |
| Shopify UTM | Feb 8 | 0 days | PASS | - |
| Facebook Ads Insights | **Feb 2** | **6 days** | **FAIL** | **~$120K spend untracked** |
| Facebook Legacy (ads_insights) | Feb 2 | 6 days | FAIL | Same source |
| TikTok Ads | Feb 5 | 3 days | WARNING | ~$6K spend untracked |
| GA4 EU | Feb 6 | 2 days | PASS | Normal J-1/J-2 |
| GA4 US | Feb 6 | 2 days | PASS | Normal J-1/J-2 |
| GA4 CA | Feb 7 | 1 day | PASS | Normal |

### Root Cause Analysis

**Facebook (CRITICAL):** The Airbyte Facebook Marketing connector has not synced since February 2. This is a 6-day gap representing approximately $120,000 in untracked advertising spend. The connector runs on a 24-hour schedule, so it has failed at least 5 consecutive sync attempts. Likely causes: expired Facebook access token, API rate limiting, or Airbyte worker crash.

**Shopify & TikTok (WARNING):** Both sources are 3 days behind. Since they use the same Airbyte instance, this suggests either: (a) the entire Airbyte VM had downtime Feb 5-8, or (b) individual connector issues. The fact that both stopped on the same date points to a VM-level issue.

### Remediation

1. SSH to Airbyte VM (see `docs/RUNBOOK.md`)
2. Check all connection statuses
3. Trigger manual sync for Facebook Marketing, Shopify, and TikTok
4. If Facebook token expired: regenerate System User token in Meta Business Suite
5. The `sync_watchdog.py` script has been created to monitor this going forward

---

## 2. PII Hashing Compliance

### Status: PASS - Zero Plaintext Exposure

| Table | Rows | Hashed Emails | Hashed Phones | Plaintext | Status |
|-------|------|--------------|---------------|-----------|--------|
| shopify_live_orders_clean | 9,865 | 9,865 (100%) | 9,865 (100%) | 0 | PASS |
| shopify_live_customers_clean | 13,350 | 13,350 (100%) | 13,299 (99.6%) | 0 | PASS |
| shopify_live_orders (raw) | 9,865 | nullified | nullified | 0 | PASS |
| shopify_live_customers (raw) | 13,350 | nullified | nullified | 0 | PASS |

### Hash Job Health

- Schedule: Every 5 minutes
- Runs in last hour: 12 (on schedule)
- Errors in last hour: 0
- Last execution: within 5 minutes
- Hash format: SHA-256 (64-character hex)
- 51 customers with null phone_hash = customers who never provided a phone number (not a bug)

### Cross-Table Hash Consistency

- 6,888 out of 9,175 unique order email hashes match a customer record (75%)
- The 25% unmatched are guest checkouts (orders placed without creating a customer account)
- This is expected behavior for e-commerce

---

## 3. Duplicate Detection

| Table | Total Rows | Duplicates | Rate | Status |
|-------|-----------|------------|------|--------|
| shopify_live_orders | 9,865 | 0 | 0% | PASS |
| shopify_live_orders_clean | 9,865 | 0 | 0% | PASS |
| shopify_live_customers | 13,350 | 0 | 0% | PASS |
| shopify_live_customers_clean | 13,350 | 0 | 0% | PASS |
| shopify_orders | 585,927 | 0 | 0% | PASS |
| shopify_utm | 592,091 | 0 (by order_id) | 0% | PASS |
| **facebook_ads_insights** | **159,342** | **33,253** | **20.9%** | **WARNING** |
| tiktokads_reports_daily | 30,287 | 0 | 0% | PASS |

### Facebook Duplicates - Root Cause & Fix

**Cause:** The Airbyte Facebook connector (connection `facebook_ads_insights`) uses **append mode**. Each sync re-ingests recent days of data, creating overlapping records.

**Fix applied:** Created 4 dedup views in BigQuery:
- `facebook_insights` (126,089 clean rows)
- `facebook_insights_age_gender`
- `facebook_insights_country`
- `facebook_insights_region`

Each view uses `ROW_NUMBER() OVER (PARTITION BY ad_id, date_start, account_id ORDER BY _airbyte_extracted_at DESC)` to keep only the latest version of each record.

**Rule: Always use the clean views (`facebook_insights`, etc.) for Facebook analysis. Never query raw `facebook_ads_insights` directly.**

---

## 4. Temporal Continuity

| Source | Missing Days (last 30) | Details | Status |
|--------|----------------------|---------|--------|
| Shopify Orders | 2 | Feb 6-7 | WARNING |
| Facebook Ads | **5** | **Feb 3-7** | **FAIL** |
| TikTok Ads | 2 | Feb 6-7 | WARNING |

The Facebook gap (5 days) aligns with the connector being down since Feb 2. Shopify and TikTok both missing Feb 6-7 suggests Airbyte VM was also down on those dates.

---

## 5. Data Volume Summary

| Dataset | Tables | Total Rows | Total Size |
|---------|--------|------------|------------|
| ads_data | 49 tables | ~4.5M rows | ~7.1 GB |
| GA4 EU (334792038) | Daily + Intraday | streaming | - |
| GA4 US (454869667) | Daily + Intraday | streaming | - |
| GA4 CA (454871405) | Daily + Intraday | streaming | - |

### Key Table Sizes

| Table | Rows | Size |
|-------|------|------|
| facebook_ads_insights_age_and_gender | 1,494,810 | 3.6 GB |
| facebook_ads_insights_country | 332,442 | 1.1 GB |
| facebook_ads_insights_region | 911,412 | 862 MB |
| tiktokads_audience_reports_by_province_daily | 1,052,020 | 552 MB |
| facebook_ads_insights | 159,342 | 819 MB |
| shopify_orders | 585,927 | 160 MB |
| shopify_utm | 592,091 | 128 MB |

---

## 6. Cross-Platform ROAS Analysis (Last 30 Days)

### Current Performance

| Platform | Ad Spend | Attributed Revenue | ROAS | Status |
|----------|----------|-------------------|------|--------|
| Facebook | $365,294 | $492,856 | **1.35x** | Profitable |
| TikTok | $36,026 | $30,917 | **0.86x** | Below breakeven |

### Data Available for Analysis

| Analysis Type | Ready? | Data Sources | Notes |
|--------------|--------|-------------|-------|
| **ROAS by Campaign** | YES | shopify_utm + facebook_insights | 22/38 UTM campaigns match Facebook campaign names |
| **CAC (Customer Acquisition Cost)** | YES | shopify_utm (customer_order_index = 1) | First-order tracking available |
| **LTV by Acquisition Channel** | YES | shopify_utm (email_hash + all orders) | Cross-order customer tracking via hash |
| **First vs Last Touch Attribution** | YES | shopify_utm (first_utm_* + last_utm_*) | Dual attribution model built in |
| **Geo Performance** | YES | facebook_insights_region + GA4 | Cross-platform geo matching |
| **Creative Performance** | YES | facebook_insights + facebook_ad_creatives | Join on ad_id |
| **Audience Insights** | YES | facebook_insights_age_gender | Age/gender breakdown |
| **TikTok Campaign ROAS** | YES | shopify_utm + tiktok_ads_reports_daily | 34/34 UTM campaigns match TikTok |

### Recommended Analysis Queries

#### A. ROAS by Campaign

```sql
SELECT
  u.first_utm_campaign AS campaign,
  COUNT(DISTINCT u.order_id) AS orders,
  ROUND(SUM(CAST(u.total_price AS FLOAT64)), 2) AS revenue,
  f.spend,
  ROUND(SUM(CAST(u.total_price AS FLOAT64)) / NULLIF(f.spend, 0), 2) AS roas
FROM `hulken.ads_data.shopify_utm` u
LEFT JOIN (
  SELECT campaign_name, ROUND(SUM(CAST(spend AS FLOAT64)), 2) AS spend
  FROM `hulken.ads_data.facebook_insights`
  GROUP BY 1
) f ON u.first_utm_campaign = f.campaign_name
WHERE u.first_utm_source LIKE '%facebook%'
GROUP BY 1, f.spend
ORDER BY revenue DESC
```

#### B. Customer Acquisition Cost (CAC)

```sql
SELECT
  first_utm_source AS channel,
  COUNT(DISTINCT email_hash) AS new_customers,
  ROUND(SUM(CAST(total_price AS FLOAT64)), 2) AS first_order_revenue,
  ROUND(SUM(CAST(total_price AS FLOAT64)) / COUNT(DISTINCT email_hash), 2) AS avg_first_order
FROM `hulken.ads_data.shopify_utm`
WHERE customer_order_index = 1
GROUP BY 1
ORDER BY new_customers DESC
```

#### C. Lifetime Value by Acquisition Channel

```sql
WITH first_touch AS (
  SELECT email_hash, first_utm_source AS acquisition_channel
  FROM `hulken.ads_data.shopify_utm`
  WHERE customer_order_index = 1
),
all_orders AS (
  SELECT email_hash, SUM(CAST(total_price AS FLOAT64)) AS lifetime_revenue,
    COUNT(*) AS total_orders
  FROM `hulken.ads_data.shopify_utm`
  GROUP BY 1
)
SELECT
  ft.acquisition_channel,
  COUNT(DISTINCT ft.email_hash) AS customers,
  ROUND(AVG(ao.total_orders), 1) AS avg_orders,
  ROUND(SUM(ao.lifetime_revenue), 2) AS total_ltv,
  ROUND(SUM(ao.lifetime_revenue) / COUNT(DISTINCT ft.email_hash), 2) AS avg_ltv
FROM first_touch ft
JOIN all_orders ao ON ft.email_hash = ao.email_hash
GROUP BY 1
ORDER BY total_ltv DESC
```

#### D. First-Touch vs Last-Touch Attribution Comparison

```sql
SELECT
  first_utm_source AS first_touch_channel,
  last_utm_source AS last_touch_channel,
  COUNT(*) AS conversions,
  ROUND(SUM(CAST(total_price AS FLOAT64)), 2) AS revenue
FROM `hulken.ads_data.shopify_utm`
WHERE first_utm_source IS NOT NULL
  AND last_utm_source IS NOT NULL
  AND first_utm_source != last_utm_source
GROUP BY 1, 2
HAVING conversions >= 10
ORDER BY revenue DESC
```

#### E. Daily Cross-Platform Spend vs Revenue

```sql
WITH daily_spend AS (
  SELECT date_start AS dt,
    ROUND(SUM(CAST(spend AS FLOAT64)), 2) AS fb_spend
  FROM `hulken.ads_data.facebook_insights`
  GROUP BY 1
),
daily_tiktok AS (
  SELECT DATE(stat_time_day) AS dt,
    ROUND(SUM(CAST(JSON_EXTRACT_SCALAR(metrics, '$.spend') AS FLOAT64)), 2) AS tt_spend
  FROM `hulken.ads_data.tiktok_ads_reports_daily`
  GROUP BY 1
),
daily_revenue AS (
  SELECT DATE(created_at) AS dt,
    ROUND(SUM(CAST(total_price AS FLOAT64)), 2) AS revenue,
    COUNT(*) AS orders
  FROM `hulken.ads_data.shopify_utm`
  GROUP BY 1
)
SELECT
  r.dt,
  COALESCE(r.revenue, 0) AS revenue,
  COALESCE(r.orders, 0) AS orders,
  COALESCE(f.fb_spend, 0) AS facebook_spend,
  COALESCE(t.tt_spend, 0) AS tiktok_spend,
  COALESCE(f.fb_spend, 0) + COALESCE(t.tt_spend, 0) AS total_spend,
  ROUND(COALESCE(r.revenue, 0) / NULLIF(COALESCE(f.fb_spend, 0) + COALESCE(t.tt_spend, 0), 0), 2) AS blended_roas
FROM daily_revenue r
LEFT JOIN daily_spend f ON r.dt = f.dt
LEFT JOIN daily_tiktok t ON r.dt = t.dt
WHERE r.dt >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
ORDER BY r.dt DESC
```

---

## 7. Infrastructure Changes Made

### This Session

1. **Created 4 Facebook dedup views** in BigQuery
   - `facebook_insights`
   - `facebook_insights_age_gender`
   - `facebook_insights_country`
   - `facebook_insights_region`

2. **Upgraded reconciliation script** (`reconciliation_check.py` v2)
   - Every check now includes: cause, impact, action
   - Added sync lag monitoring check
   - Fixed TikTok table name (`tiktokads_reports_daily`)
   - Action items summary at end of report

3. **Created sync watchdog** (`sync_watchdog.py`)
   - Monitors all table freshness every hour
   - Configurable thresholds (warning at 30h, critical at 48h)
   - Email and Slack alerting (configure in `.env`)
   - Anti-spam: won't re-alert for same tables within 4 hours
   - Log file at `data_validation/sync_watchdog.log`

---

## 8. Action Items

### CRITICAL (Do Now)
- [ ] SSH to Airbyte VM and restart Facebook Marketing sync
- [ ] Restart Shopify and TikTok syncs
- [ ] Verify data backfills after sync restart

### IMPORTANT (This Week)
- [ ] Set up `sync_watchdog.py` as hourly scheduled task
- [ ] Configure email/Slack alerts in `.env`
- [ ] Consider switching Airbyte Facebook connector to dedup mode

### NICE TO HAVE
- [ ] Reduce Airbyte sync interval from 24h to 12h for redundancy
- [ ] Create BigQuery scheduled query for sync monitoring dashboard
- [ ] Investigate 1,481 shopify_utm duplicates (0.2% - low impact)
